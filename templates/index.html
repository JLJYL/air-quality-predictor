<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ city_name }} AQI 預測</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f7f7ff; }
        .aqi-50 { background-color: #10B981; } /* 綠 */
        .aqi-100 { background-color: #EAB308; } /* 黃 */
        .aqi-150 { background-color: #F97316; } /* 橘 */
        .aqi-200 { background-color: #DC2626; } /* 紅 */
        .aqi-300 { background-color: #7C3AED; } /* 紫 */
    </style>
</head>
<body class="p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                {{ city_name }} 空氣品質預測
            </h1>
            <p class="text-lg text-gray-600">未來 24 小時 AQI 趨勢</p>
        </header>

        <div id="maxAqiCard" class="shadow-2xl rounded-xl p-8 mb-10 text-white flex justify-between items-center" 
             style="background-color: #2c3e50;">
            
            <div>
                <p class="text-lg font-medium opacity-80">
                    未來 24 小時內最大預測 AQI
                </p>
                <h2 id="maxAqiValue" class="text-7xl font-black mt-1">
                    {{ max_aqi }}
                </h2>
            </div>
            
            <div id="aqiStatus" class="rounded-full px-6 py-2 text-xl font-bold text-white shadow-md">
                {% if max_aqi == "N/A" %}
                    N/A
                {% elif max_aqi | int <= 50 %}
                    良好
                {% elif max_aqi | int <= 100 %}
                    普通
                {% elif max_aqi | int <= 150 %}
                    對敏感族群不健康
                {% elif max_aqi | int <= 200 %}
                    不健康
                {% else %}
                    非常不健康
                {% endif %}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-xl p-6 mb-10">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">
                AQI 趨勢圖
            </h3>
            <div class="relative" style="height: 400px;">
                <canvas id="aqiChart"></canvas>
            </div>
        </div>
        
    </div> 
    
    <script>
        // --- 1. 數據變數安全傳輸與解析 (極簡版安全處理) ---
        let predictions = [];
        try {
            // 注意：如果您的 Flask 傳輸數據有問題，這裡仍可能是錯誤點
            const aqi_predictions_json = '{{ aqi_predictions | tojson | safe }}';
            if (aqi_predictions_json && aqi_predictions_json !== 'null' && aqi_predictions_json !== 'None') {
                predictions = JSON.parse(aqi_predictions_json);
            }
        } catch (e) {
            console.error("AQI 數據解析失敗:", e); 
        }
        // --------------------------------------------------------

        function getAqiColor(aqi) {
            if (aqi === "N/A" || isNaN(aqi) || aqi === null) return '#9CA3AF';
            if (aqi <= 50) return '#10B981'; 
            if (aqi <= 100) return '#EAB308'; 
            if (aqi <= 150) return '#F97316'; 
            if (aqi <= 200) return '#DC2626'; 
            return '#7C3AED'; 
        }
        
        // 更新頂部卡片的顏色 (使用內聯樣式，更穩定)
        function updateAqiColors() {
            const aqiStatusElement = document.getElementById('aqiStatus');
            const maxAqiValue = parseInt(document.getElementById('maxAqiValue').innerText.trim());

            let colorClass = 'aqi-default';
            if (!isNaN(maxAqiValue)) {
                if (maxAqiValue <= 50) colorClass = 'aqi-50';
                else if (maxAqiValue <= 100) colorClass = 'aqi-100';
                else if (maxAqiValue <= 150) colorClass = 'aqi-150';
                else if (maxAqiValue <= 200) colorClass = 'aqi-200';
                else colorClass = 'aqi-300';
            }
            // 移除舊類別，新增新類別 (使用 Tailwind CSS 顏色定義)
            aqiStatusElement.className = aqiStatusElement.className.split(' ').filter(c => !c.startsWith('bg-')).join(' ');
            aqiStatusElement.classList.add(colorClass.replace('@apply bg-', ''));
        }

        function createAqiChart() {
            if (!predictions || predictions.length === 0) {
                return;
            }

            const labels = predictions.map(p => {
                const parts = p.time.split(' '); 
                return `${parts[0].substring(5)} ${parts[1]}`; 
            });

            const data = predictions.map(p => {
                const aqi = p.aqi;
                return (aqi === "N/A" || isNaN(aqi) || aqi === null) ? null : parseInt(aqi);
            });
            
            // 新增：處理觀測值與預測值的資料集
            let datasets = [];
            const isFallback = predictions.length === 1 && predictions[0].is_obs;

            if (isFallback) {
                // 回退模式：只顯示一個觀測點
                datasets.push({
                    label: '最新觀測 AQI',
                    data: data,
                    borderColor: '#9CA3AF',
                    backgroundColor: 'rgba(156, 163, 175, 0.5)',
                    borderWidth: 5,
                    pointRadius: 8,
                    pointBackgroundColor: getAqiColor(data[0]),
                    pointBorderColor: '#fff',
                    type: 'bubble' // 使用氣泡圖標記觀測點
                });
            } else {
                // 預測模式：線圖
                const borderColors = data.map(aqi => getAqiColor(aqi));
                datasets.push({
                    label: '預測 AQI 數值',
                    data: data,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointBackgroundColor: borderColors,
                    pointBorderColor: '#fff',
                });
            }

            const ctx = document.getElementById('aqiChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line', // 即使回退模式也使用 line 來保持 x 軸標籤一致
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 200, // 設一個較保守的上限
                            ticks: {
                                callback: function(value) {
                                    return (value <= 200) ? value : null; // 超過 200 不顯示刻度
                                }
                            }
                        },
                        x: { 
                            ticks: {
                                maxRotation: 45, minRotation: 45,
                                callback: function(value, index) {
                                    const fullLabel = this.getLabelForValue(value);
                                    const parts = fullLabel.split(' ');
                                    return (index % 6 === 0) ? fullLabel : parts[1]; 
                                }
                            }
                        }
                    },
                    // 新增 Tooltip 回呼函式以顯示是否為觀測值
                    tooltips: {
                        callbacks: {
                            title: function(tooltipItems, data) {
                                const index = tooltipItems[0].dataIndex;
                                if (predictions[index] && predictions[index].is_obs) {
                                    return '【最新觀測】';
                                }
                                return '預測';
                            },
                            label: function(tooltipItem, data) {
                                let label = data.datasets[tooltipItem.datasetIndex].label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += tooltipItem.yLabel;
                                return label;
                            }
                        }
                    }
                }
            });
        }

        window.onload = function() {
            updateAqiColors();
            createAqiChart();
        };
    </script>
</body>
</html>
