<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ city_name }} - AQI 24 å°æ™‚é æ¸¬</title>
    <!-- å°å…¥ Tailwind CSSï¼Œç”¨æ–¼éŸ¿æ‡‰å¼ä½ˆå±€å’Œæ¨£å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å°å…¥ Chart.jsï¼Œç”¨æ–¼ç¹ªè£½æŠ˜ç·šåœ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* ç¢ºä¿å­—é«”å’ŒèƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        /* å®šç¾© AQI é¡è‰²é¡åˆ¥ï¼Œéµå¾ªæ¨™æº–ç©ºæ°£å“è³ªé¡è‰²ç¢¼ */
        .aqi-good { background-color: #00e400; color: white; } /* 0-50 ç¶ è‰² (è‰¯å¥½) */
        .aqi-moderate { background-color: #ff9900; color: white; } /* 51-100 æ©˜è‰² (æ™®é€š) */
        .aqi-unhealthy-sensitive { background-color: #ff0000; color: white; } /* 101-150 ç´…è‰² (å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·) */
        .aqi-unhealthy { background-color: #8f3f97; color: white; } /* 151-200 ç´«è‰² (ä¸å¥åº·) */
        .aqi-very-unhealthy { background-color: #7e0023; color: white; } /* > 200 æ —è‰² (éå¸¸ä¸å¥åº·) */
        .aqi-na { background-color: #a0a0a0; color: white; } /* N/A ç°è‰² (ç„¡æ•¸æ“š) */
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">

        <!-- Header: æ¨™é¡Œå’Œå‰¯æ¨™é¡Œ -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 tracking-tight">
                {{ city_name }} ç©ºæ°£å“è³ªé æ¸¬
            </h1>
            <p class="text-lg text-gray-500 mt-1">æœªä¾† 24 å°æ™‚ AQI è¶¨å‹¢åˆ†æ</p>
        </header>

        <!-- Current Status & Max AQI Card: é¡¯ç¤ºæœ€é«˜é æ¸¬å€¼å’Œæœ€æ–°è§€æ¸¬æ™‚é–“ -->
        <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Max AQI Card (æœ€é«˜ AQI) -->
            <div class="p-6 rounded-lg shadow-xl transition-all duration-300" id="max-aqi-card">
                <p class="text-sm font-semibold text-gray-700 uppercase">é æ¸¬æœŸé–“ (24H) æœ€é«˜ AQI</p>
                <div class="flex items-center justify-between mt-2">
                    <!-- max_aqi è®Šæ•¸ -->
                    <!-- ä¿®æ­£: ç¢ºä¿å³ä½¿ max_aqi ç‚ºç©º/null æ™‚ï¼Œä¹Ÿèƒ½é¡¯ç¤º 'N/A' -->
                    <span id="max-aqi-display" class="text-6xl font-extrabold">{{ max_aqi if max_aqi is not none and max_aqi != '' else 'N/A' }}</span>
                    <!-- AQI ç‹€æ…‹æ¨™ç±¤ -->
                    <span id="aqi-status" class="text-xl font-bold rounded-full px-4 py-2 shadow-md"></span>
                </div>
                <p class="text-sm text-gray-500 mt-3">
                    {% if is_fallback %}
                    <span class="font-bold text-red-500">âš ï¸ åƒ…é¡¯ç¤ºæœ€æ–°è§€æ¸¬å€¼ã€‚</span> é æ¸¬æ¨¡å‹ç„¡æ³•å•Ÿå‹•ã€‚
                    {% else %}
                    é æ¸¬æœŸé–“ (24H) çš„æœ€é«˜æŒ‡æ•¸ã€‚
                    {% endif %}
                </p>
            </div>

            <!-- Current Observation Time (æœ€æ–°è§€æ¸¬æ™‚é–“) -->
            <div class="p-6 bg-blue-50 rounded-lg shadow-inner flex flex-col justify-center">
                <p class="text-sm font-semibold text-blue-700 uppercase">æœ€æ–°è§€æ¸¬æ™‚é–“ (æœ¬åœ°æ™‚å€)</p>
                <p class="text-2xl font-bold text-gray-800 mt-1">{{ current_obs_time }}</p>
                <p class="text-sm text-gray-500 mt-3">
                    æ•¸æ“šä¾†è‡ª OpenAQ å¹³å°ï¼Œç”¨æ–¼æ¨¡å‹é æ¸¬èµ·é»ã€‚
                </p>
            </div>
        </div>
        
        <!-- Prediction Chart Section: ç¹ªè£½ AQI è¶¨å‹¢åœ–è¡¨ -->
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">AQI 24 å°æ™‚é æ¸¬è¶¨å‹¢</h2>
            <div class="h-80 w-full">
                <!-- åœ–è¡¨ Canvas -->
                <canvas id="aqiChart"></canvas>
            </div>
            <p class="text-xs text-gray-400 mt-4 text-center">
                æ›²ç·šåœ–é¡¯ç¤ºæœªä¾† 24 å€‹å°æ™‚çš„ç©ºæ°£å“è³ªæŒ‡æ•¸ (AQI) é æ¸¬å€¼ã€‚
            </p>
        </div>

    </div>

    <!-- JavaScript for Chart Drawing and UI Updates (åœ–è¡¨ç¹ªè£½å’Œ UI æ›´æ–°çš„ JavaScript) -->
    <script>
        // ä½¿ç”¨ | tojson éæ¿¾å™¨ï¼Œç¢ºä¿è®Šæ•¸ä»¥æ­£ç¢ºçš„ JavaScript å­—é¢é‡å½¢å¼æ’å…¥
        const aqiPredictions = {{ aqi_predictions | tojson }};
        const maxAqiValue = {{ max_aqi | tojson }}; 
        const isFallback = {{ is_fallback | tojson }};

        /**
         * æ ¹æ“š AQI å€¼ç²å–å°æ‡‰çš„é¡è‰²å’Œæè¿°
         * @param {number} aqi 
         * @returns {{color: string, status: string, tailwindClass: string}}
         */
        function getAqiInfo(aqi) {
            // æª¢æŸ¥ AQI æ˜¯å¦ç‚ºç„¡æ•ˆå€¼
            if (aqi === 'N/A' || isNaN(aqi) || aqi === null) {
                return { color: '#a0a0a0', status: 'ç„¡æ•¸æ“š', tailwindClass: 'aqi-na' };
            }
            if (aqi <= 50) return { color: '#00e400', status: 'è‰¯å¥½', tailwindClass: 'aqi-good' };
            if (aqi <= 100) return { color: '#ff9900', status: 'æ™®é€š', tailwindClass: 'aqi-moderate' };
            if (aqi <= 150) return { color: '#ff0000', status: 'å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·', tailwindClass: 'aqi-unhealthy-sensitive' };
            if (aqi <= 200) return { color: '#8f3f97', status: 'ä¸å¥åº·', tailwinqdClass: 'aqi-unhealthy' };
            return { color: '#7e0023', status: 'éå¸¸ä¸å¥åº·', tailwindClass: 'aqi-very-unhealthy' };
        }

        /**
         * æ›´æ–°é é¢ä¸Šçš„æœ€é«˜ AQI ç‹€æ…‹å¡ç‰‡ (é¡è‰²å’Œæ–‡å­—)
         */
        function updateAqiStatusCard() {
            // maxAqiValue ç¾åœ¨å¯èƒ½æ˜¯ 'N/A'
            const aqi = parseInt(maxAqiValue); 
            const info = getAqiInfo(aqi);
            const card = document.getElementById('max-aqi-card');
            const statusSpan = document.getElementById('aqi-status');
            
            // ç§»é™¤èˆŠçš„èƒŒæ™¯è‰²ä¸¦æ·»åŠ æ–°çš„èƒŒæ™¯è‰²
            const classesToRemove = ['aqi-good', 'aqi-moderate', 'aqi-unhealthy-sensitive', 'aqi-unhealthy', 'aqi-very-unhealthy', 'aqi-na'];
            statusSpan.classList.remove(...classesToRemove);
            statusSpan.classList.add(info.tailwindClass);

            statusSpan.textContent = info.status;
            
            // æ ¹æ“šç‹€æ…‹é¡è‰²æ›´æ–°å¡ç‰‡é‚Šæ¡†/é™°å½±é¡è‰²
            card.style.borderColor = info.color;
            card.style.borderWidth = '4px';
            // æ·»åŠ é™°å½±æ•ˆæœï¼Œè®“å¡ç‰‡æ›´çªå‡º
            card.style.boxShadow = `0 10px 15px -3px ${info.color}66, 0 4px 6px -4px ${info.color}44`;
        }

        /**
         * ç¹ªè£½ Chart.js æŠ˜ç·šåœ–
         */
        function drawChart() {
            const canvas = document.getElementById('aqiChart');
            const ctx = canvas.getContext('2d');
            
            // è™•ç†æ•¸æ“šï¼Œéæ¿¾æ‰ 'N/A' æˆ– null/éæ•¸å­—çš„å€¼
            const validPredictions = aqiPredictions.filter(p => p.aqi !== 'N/A' && p.aqi !== null && !isNaN(p.aqi));
            
            let labels = validPredictions.map(p => {
                // è½‰æ›æ™‚é–“æ ¼å¼ç‚º HH:MM
                const parts = p.time.split(' ');
                return parts.length > 1 ? parts[1].substring(0, 5) : p.time;
            });
            let data = validPredictions.map(p => p.aqi);
            let colors = validPredictions.map(p => getAqiInfo(p.aqi).color);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•æœ‰æ•ˆæ•¸æ“šé» (ä¿®å¾©ç„¡æ•¸æ“šæ™‚åœ–è¡¨ç©ºç™½çš„å•é¡Œ)
            if (data.length === 0) {
                 // åœ¨ç„¡æ•¸æ“šæ™‚é¡¯ç¤ºè­¦å‘Šæ–‡å­—
                ctx.font = '16px Inter';
                ctx.fillStyle = '#ef4444';
                ctx.textAlign = 'center';
                // è¨ˆç®—æ–‡å­—ä½ç½®
                const textX = canvas.width / 2;
                const textY = canvas.height / 2;
                ctx.fillText('ç„¡æ³•å–å¾—æœ‰æ•ˆé æ¸¬æ•¸æ“šã€‚è«‹æª¢æŸ¥å¾Œç«¯è³‡æ–™ä¾†æºã€‚', textX, textY);
                return;
            }

            // å¦‚æœåªæœ‰ä¸€å€‹é» (å›é€€æ¨¡å¼)ï¼Œå‰‡è¤‡è£½è©²é»ä»¥ç¹ªè£½å–®é»åœ–
            if (isFallback && data.length === 1) {
                // ç‚ºäº†è®“ Chart.js é¡¯ç¤ºä¸€å€‹é»ï¼Œæˆ‘å€‘éœ€è¦è‡³å°‘ 2 å€‹æ•¸æ“šé»
                labels.push(''); // æ·»åŠ ä¸€å€‹ç©ºæ¨™ç±¤
                data.push(data[0]); // é‡è¤‡æ•¸æ“šé»
                colors.push(colors[0]);
            }
            

            // ç¹ªè£½ç·šåœ–å¯¦ä¾‹
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'AQI é æ¸¬å€¼',
                        data: data,
                        // æ ¹æ“šæ•¸æ“šé»çš„ AQI å€¼è¨­ç½®é¡è‰²
                        backgroundColor: (context) => {
                            const aqi = context.dataset.data[context.dataIndex];
                            return getAqiInfo(aqi).color;
                        },
                        borderColor: '#2563eb', // ç·šæ¢é¡è‰² (è—è‰²)
                        borderWidth: 3,
                        pointRadius: 6,
                        pointBackgroundColor: colors,
                        pointHoverRadius: 8,
                        tension: 0.3, // ä½¿ç·šæ¢æ›´å¹³æ»‘
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // éš±è—åœ–ä¾‹
                        },
                        title: {
                            display: true,
                            text: isFallback ? 'ğŸš¨ åƒ…é¡¯ç¤ºå–®ä¸€è§€æ¸¬æ•¸æ“š' : 'æœªä¾† 24 å°æ™‚ AQI é æ¸¬',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ™‚é–“ (æœ¬åœ°æ™‚å€)'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                // åªé¡¯ç¤ºæ¯ 3 å€‹æ¨™ç±¤ï¼Œé¿å…éåº¦æ“æ“ 
                                callback: function(value, index, values) {
                                    return index % 3 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'AQI æŒ‡æ•¸'
                            },
                            min: 0,
                            max: 200, // å›ºå®š Y è»¸ç¯„åœä»¥ä¿æŒä¸€è‡´æ€§ (0-200 è¦†è“‹å¤§éƒ¨åˆ†æƒ…æ³)
                            grid: {
                                borderColor: '#ddd',
                                borderWidth: 1,
                                // æ·»åŠ  AQI é–¾å€¼ç·šï¼Œå¹«åŠ©è¦–è¦ºåŒ–å“è³ªç­‰ç´š
                                color: (context) => {
                                    if (context.tick.value === 50) return '#00e400'; // è‰¯å¥½
                                    if (context.tick.value === 100) return '#ff9900'; // æ™®é€š
                                    if (context.tick.value === 150) return '#ff0000'; // ä¸å¥åº·
                                    return 'rgba(0, 0, 0, 0.1)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // é é¢è¼‰å…¥å¾ŒåŸ·è¡Œåˆå§‹åŒ–å’Œç¹ªåœ–
        window.onload = function() {
            updateAqiStatusCard();
            drawChart();
        };

    </script>
</body>
</html>
