<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AQI 觀測趨勢</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: sans-serif; background-color: #f7f7ff; }
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 60px; height: 60px;
      border: 6px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>

  <script>
  // 從後端接收的數據會放在這個變數中，用於繪圖
  const chartData = JSON.parse('{{ chart_data | tojson | safe }}');
  const locationName = '{{ location_name | default("N/A") }}';
  const latestAqi = '{{ latest_aqi | default("N/A") }}';
  const latestTime = '{{ latest_time | default("N/A") }}';

  // --- 定位功能：取得用戶座標並重新導向 ---
  const requestLocation = () => {
    // 檢查 URL 中是否已經有 lat/lon 參數
    const currentParams = new URLSearchParams(window.location.search);
    if (currentParams.has('lat') && currentParams.has('lon')) {
        // 如果已經有座標，則跳過，讓 DOMContentLoaded 繼續執行
        return; 
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                // 成功取得座標後，重新載入頁面並帶上座標參數
                window.location.search = `?lat=${lat}&lon=${lon}`;
            },
            (error) => {
                // 如果定位失敗，則繼續執行，讓後端使用預設座標
                console.warn('Geolocation failed:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
            },
            { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
        );
    } else {
        console.warn('Geolocation is not supported by this browser.');
        document.getElementById('loadingOverlay').style.display = 'none';
    }
  }
  
  // 在頁面載入時先嘗試取得座標
  requestLocation();
  // ---------------------------------------------


  document.addEventListener("DOMContentLoaded", function () {
      const loadingOverlay = document.getElementById('loadingOverlay');
      const errorDiv = document.getElementById('error-message');
      
      // 處理錯誤訊息
      const errorMessage = '{{ error_message | default("") }}';
      if (errorMessage) {
          errorDiv.textContent = errorMessage;
          errorDiv.classList.remove('hidden');
          loadingOverlay.style.display = 'none';
          return;
      }
      
      // 顯示最新 AQI 資訊
      document.getElementById('location-name').textContent = locationName;
      document.getElementById('latest-aqi-value').textContent = latestAqi;
      document.getElementById('latest-time-value').textContent = latestTime;

      // 根據 U.S. EPA AQI 顏色標準
      const aqiBox = document.getElementById('latest-aqi-box');
      const aqi = parseInt(latestAqi);
      if (!isNaN(aqi)) {
          if (aqi <= 50) {
              aqiBox.className = 'bg-green-500'; // 綠色 (Good)
          } else if (aqi <= 100) {
              aqiBox.className = 'bg-yellow-500'; // 黃色 (Moderate)
          } else if (aqi <= 150) {
              aqiBox.className = 'bg-orange-500'; // 橘色 (Unhealthy for Sensitive Groups)
          } else if (aqi <= 200) {
              aqiBox.className = 'bg-red-500'; // 紅色 (Unhealthy)
          } else if (aqi <= 300) {
              aqiBox.className = 'bg-purple-600'; // 紫色 (Very Unhealthy)
          } else {
              aqiBox.className = 'bg-maroon-700'; // 褐紅色 (Hazardous)
          }
      }

      // 繪製圖表
      if (chartData && chartData.length > 0) {
          renderChart(chartData, locationName);
      }
      
      // 如果已經執行到這裡，且沒有錯誤，代表數據已載入或正在等待定位
      if (!errorMessage && (!chartData || chartData.length === 0)) {
          // 如果沒有圖表數據但沒有錯誤，可能是在等待定位或第一次載入
      } else {
          loadingOverlay.style.display = 'none';
      }
  });

  const renderChart = (data, locationName) => {
      
      // 提取標籤 (X 軸) 和數據 (Y 軸)
      const labels = data.map(d => d.datetime.split(' ')[1]); // 只取時間部分
      const aqiValues = data.map(d => d.aqi); // 觀測 AQI 值

      // 找出最大的 AQI 值來設定 Y 軸上限
      const maxAqi = Math.max(...aqiValues);
      const yMax = Math.max(100, Math.ceil(maxAqi / 50) * 50);

      try {
          const ctx = document.getElementById('aqiChart').getContext('2d');
          
          if (window.aqiChart) {
              window.aqiChart.destroy();
          }

          window.aqiChart = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: '觀測 AQI (Observed AQI)', // 標籤改為觀測 AQI
                      data: aqiValues,
                      borderColor: '#3B82F6',
                      backgroundColor: 'rgba(59, 130, 246, 0.1)',
                      fill: true,
                      tension: 0.3,
                      pointRadius: 3,
                      pointHoverRadius: 5,
                      pointBackgroundColor: (context) => {
                          const v = context.raw;
                          if (v <= 50) return '#10B981'; // 綠
                          if (v <= 100) return '#EAB308'; // 黃
                          if (v <= 150) return '#F97316'; // 橘
                          if (v <= 200) return '#DC2626'; // 紅
                          return '#7C3AED'; // 紫 (非常不健康)
                      },
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      title: {
                          display: true,
                          text: `過去 24 小時 ${locationName} 實際觀測 AQI 趨勢 (U.S. EPA 2024)`,
                          font: { size: 16 }
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: true,
                          suggestedMax: yMax,
                          ticks: { stepSize: 10 },
                          grid: {
                              color: (ctx) => (ctx.tick.value % 50 === 0 ? '#9CA3AF' : '#E5E7EB'),
                              lineWidth: (ctx) => (ctx.tick.value % 50 === 0 ? 1.5 : 0.5)
                          }
                      },
                      x: {
                          ticks: {
                              maxRotation: 45, 
                              minRotation: 45,
                              callback: function(value, index) {
                                  const fullLabel = this.getLabelForValue(value);
                                  // 只顯示時間
                                  return (index % 6 === 0) ? fullLabel : fullLabel.split(' ')[1];
                              }
                          }
                      }
                  }
              }
          });
      } catch (e) {
          console.error('Chart rendering failed:', e);
      }
  };
  </script>
</head>
<body class="p-4 sm:p-8">

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p class="mt-4 text-gray-700">正在抓取歷史觀測數據...</p>
    <p class="mt-2 text-sm text-gray-500">如果停留過久，可能是瀏覽器正在請求您的地理位置資訊。</p>
  </div>

  <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
    </div>

  <h1 class="text-3xl font-bold text-gray-800 mb-6">空氣品質觀測儀 (U.S. EPA 2024 標準)</h1>

  <div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold text-gray-600">監測站位置</h2>
        <p id="location-name" class="text-2xl font-bold text-gray-800">{{ location_name | default('N/A') }}</p>
      </div>
      <div class="flex items-center space-x-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-600 text-right">最新觀測時間 (臺灣)</h2>
          <p id="latest-time-value" class="text-xl font-bold text-gray-800 text-right">{{ latest_time | default('N/A') }}</p>
        </div>
        <div id="latest-aqi-box" class="w-24 h-24 flex flex-col items-center justify-center rounded-lg shadow-lg">
          <span class="text-xs font-semibold text-white">觀測 AQI</span>
          <p id="latest-aqi-value" class="text-4xl font-extrabold text-white leading-none">{{ latest_aqi | default('N/A') }}</p>
        </div>
      </div>
    </div>
    <p class="mt-4 text-sm text-gray-500">
      * 數據來自 OpenAQ 觀測資料，AQI 根據 **U.S. EPA 2024 標準**計算。
    </p>
  </div>

  <div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">AQI 歷史觀測趨勢 (過去 24 小時)</h2>
    <div class="relative h-96">
      <canvas id="aqiChart"></canvas>
    </div>
  </div>
</body>
</html>
