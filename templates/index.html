<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AQI Forecast</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: sans-serif; background-color: #f7f7ff; }
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 60px; height: 60px;
      border: 6px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    /* æ–°å¢ï¼šèª¿è©¦è³‡è¨Šé¡¯ç¤ºå€ */
    #debugInfo {
      background: #1f2937;
      color: #10b981;
      padding: 1rem;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.875rem;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    .debug-line { margin: 0.25rem 0; }
    .debug-error { color: #ef4444; }
    .debug-success { color: #10b981; }
    .debug-warning { color: #f59e0b; }
  </style>

  <script>
  // å…¨å±€èª¿è©¦å‡½æ•¸
  function debugLog(message, type = 'info') {
    console.log(message);
    const debugDiv = document.getElementById('debugInfo');
    if (debugDiv) {
      const line = document.createElement('div');
      line.className = `debug-line debug-${type}`;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      debugDiv.appendChild(line);
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
      debugLog('é é¢è¼‰å…¥å®Œæˆ', 'success');
      
      const params = new URLSearchParams(window.location.search);
      if (params.has("lat") && params.has("lon")) {
          debugLog(`ä½¿ç”¨ URL åº§æ¨™: lat=${params.get('lat')}, lon=${params.get('lon')}`, 'info');
          document.getElementById("loadingOverlay").style.display = "none";
          document.getElementById("content").style.display = "block";
          return;
      }

      const overlay = document.getElementById("loadingOverlay");
      overlay.style.display = "flex";
      const loadingText = document.getElementById("loadingText");

      if (navigator.geolocation) {
          loadingText.innerText = "æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®...";
          debugLog('é–‹å§‹å®šä½...', 'info');
          
          navigator.geolocation.getCurrentPosition(
              (position) => {
                  const lat = position.coords.latitude.toFixed(6);
                  const lon = position.coords.longitude.toFixed(6);
                  debugLog(`å®šä½æˆåŠŸ: lat=${lat}, lon=${lon}`, 'success');
                  loadingText.innerText = "å®šä½å®Œæˆï¼Œæ­£åœ¨è¼‰å…¥ç©ºæ°£å“è³ªè³‡æ–™...";
                  const baseUrl = window.location.origin + window.location.pathname;
                  setTimeout(() => {
                      window.location.href = `${baseUrl}?lat=${lat}&lon=${lon}`;
                  }, 800);
              },
              (error) => {
                  debugLog(`å®šä½å¤±æ•—: ${error.message}`, 'error');
                  loadingText.innerText = "ç„¡æ³•å–å¾—å®šä½ï¼Œå°‡ä½¿ç”¨é è¨­é«˜é›„è³‡æ–™...";
                  setTimeout(() => { 
                      overlay.style.display = "none"; 
                      document.getElementById("content").style.display = "block";
                  }, 1500);
              },
              { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
          );
      } else {
          debugLog('ç€è¦½å™¨ä¸æ”¯æ´å®šä½', 'warning');
          loadingText.innerText = "æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½ï¼Œä½¿ç”¨é è¨­è³‡æ–™";
          setTimeout(() => { 
              overlay.style.display = "none"; 
              document.getElementById("content").style.display = "block";
          }, 1500);
      }
  });
  </script>
</head>

<body class="p-8 min-h-screen">
  <!-- Loading ç•«é¢ -->
  <div id="loadingOverlay">
      <div class="spinner mb-4"></div>
      <p id="loadingText" class="text-gray-700 text-lg font-medium">æ­£åœ¨åˆå§‹åŒ–...</p>
  </div>

  <!-- ä¸»å…§å®¹ -->
  <div class="max-w-6xl mx-auto" style="display:none" id="content">
      <!-- ğŸ†• èª¿è©¦è³‡è¨Šå€ï¼ˆé–‹ç™¼æ™‚é¡¯ç¤ºï¼Œæ­£å¼ä¸Šç·šå¯éš±è—ï¼‰ -->
      <div class="bg-white rounded-xl shadow-xl p-4 mb-6">
          <details>
              <summary class="cursor-pointer font-bold text-gray-700 mb-2">ğŸ” ç³»çµ±è¨ºæ–·è³‡è¨Šï¼ˆé»æ“Šå±•é–‹ï¼‰</summary>
              <div id="debugInfo" class="mt-2">
                  <div class="debug-success">ç³»çµ±åˆå§‹åŒ–å®Œæˆ</div>
              </div>
          </details>
      </div>

      <header class="text-center mb-10">
          <h2 class="text-4xl font-extrabold text-gray-900 mb-2">
              Air Quality Forecast for {{ city_name }} Station
          </h2>
          <p class="text-lg text-gray-600">24-Hour AQI Trend</p>
          <!-- ğŸ†• é¡¯ç¤ºç•¶å‰è§€æ¸¬æ™‚é–“ -->
          {% if current_obs_time != "N/A" %}
          <p class="text-sm text-gray-500 mt-1">æœ€è¿‘è§€æ¸¬æ™‚é–“: {{ current_obs_time }}</p>
          {% endif %}
      </header>

      <div id="maxAqiCard" class="shadow-2xl rounded-xl p-8 mb-10 text-white flex justify-between items-center" 
           style="background-color: #2c3e50;">
          <div>
              <p class="text-lg font-medium opacity-80">
                  {% if is_fallback %}
                  ç•¶å‰è§€æ¸¬ AQI
                  {% else %}
                  æœªä¾† 24 å°æ™‚æœ€é«˜ AQI
                  {% endif %}
              </p>
              <h2 id="maxAqiValue" class="text-7xl font-black mt-1">
                  {{ max_aqi }}
              </h2>
          </div>
          <div 
            id="aqiStatus"
            class="rounded-full px-6 py-2 text-xl font-bold text-white shadow-md
            {% if max_aqi == 'N/A' or max_aqi == 'ERROR' %}
                bg-gray-500
            {% elif max_aqi | int <= 50 %}
                bg-green-500
            {% elif max_aqi | int <= 100 %}
                bg-yellow-500
            {% elif max_aqi | int <= 150 %}
                bg-orange-500
            {% elif max_aqi | int <= 200 %}
                bg-red-600
            {% else %}
                bg-purple-700
            {% endif %}
            ">
            {% if max_aqi == "N/A" %}
                ç„¡æ•¸æ“š
            {% elif max_aqi == "ERROR" %}
                éŒ¯èª¤
            {% elif max_aqi | int <= 50 %}
                Good
            {% elif max_aqi | int <= 100 %}
                Moderate
            {% elif max_aqi | int <= 150 %}
                Unhealthy for Sensitive Groups
            {% elif max_aqi | int <= 200 %}
                Unhealthy
            {% else %}
                Very Unhealthy
            {% endif %}
            </div>
      </div>

      <!-- AQI Chart -->
      <div class="bg-white rounded-xl shadow-xl p-6 mb-10">
          <h3 class="text-2xl font-bold text-gray-800 mb-4">
              {% if is_fallback %}
              ç•¶å‰ AQIï¼ˆç„¡é æ¸¬æ•¸æ“šï¼‰
              {% else %}
              AQI è¶¨å‹¢é æ¸¬
              {% endif %}
          </h3>
          <div class="relative" style="height: 400px;">
              <canvas id="aqiChart"></canvas>
          </div>
          <!-- ğŸ†• ç„¡æ•¸æ“šæç¤º -->
          <div id="noDataWarning" style="display: none;" class="text-center py-8">
              <p class="text-gray-500 text-lg">âš ï¸ æš«ç„¡é æ¸¬æ•¸æ“š</p>
              <p class="text-gray-400 text-sm mt-2">å¯èƒ½åŸå› ï¼šæ¨¡å‹æœªè¼‰å…¥æˆ–æ¸¬ç«™æ•¸æ“šä¸è¶³</p>
          </div>
      </div>
  </div>

  <script>
  window.onload = function() {
      debugLog('é–‹å§‹è¼‰å…¥åœ–è¡¨...', 'info');
      document.getElementById("content").style.display = "block";

      let predictions = [];
      try {
          const jsonStr = '{{ aqi_predictions | tojson | safe }}';
          debugLog(`æ¥æ”¶åˆ°çš„ JSON é•·åº¦: ${jsonStr.length}`, 'info');
          predictions = JSON.parse(jsonStr);
          debugLog(`è§£ææˆåŠŸï¼Œé æ¸¬æ•¸é‡: ${predictions.length}`, 'success');
      } catch (e) { 
          debugLog(`JSON è§£æå¤±æ•—: ${e.message}`, 'error');
      }

      if (!predictions || predictions.length === 0) {
          debugLog('ç„¡é æ¸¬æ•¸æ“šï¼Œé¡¯ç¤ºè­¦å‘Š', 'warning');
          document.getElementById('noDataWarning').style.display = 'block';
          document.getElementById('aqiChart').style.display = 'none';
          return;
      }

      const labels = predictions.map(p => p.time);
      const data = predictions.map(p => (p.aqi === "N/A" ? null : p.aqi));
      
      debugLog(`åœ–è¡¨æ¨™ç±¤æ•¸: ${labels.length}, æ•¸æ“šé»æ•¸: ${data.filter(d => d !== null).length}`, 'info');

      const ctx = document.getElementById('aqiChart').getContext('2d');
      const validData = data.filter(v => v !== null);
      const yMax = validData.length > 0 
          ? Math.ceil(Math.max(...validData) / 50) * 50 + 10 
          : 100;

      try {
          new Chart(ctx, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'AQI',
                      data: data,
                      borderColor: '#3B82F6',
                      backgroundColor: 'rgba(59,130,246,0.15)',
                      borderWidth: 3,
                      fill: true,
                      tension: 0.4,
                      pointRadius: 5,
                      pointBackgroundColor: data.map(v => {
                          if (v === null) return '#9CA3AF';
                          if (v <= 50) return '#10B981';
                          if (v <= 100) return '#EAB308';
                          if (v <= 150) return '#F97316';
                          if (v <= 200) return '#DC2626';
                          return '#7C3AED';
                      })
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      y: {
                          beginAtZero: true,
                          suggestedMax: yMax,
                          ticks: { stepSize: 10 },
                          grid: {
                              color: (ctx) => (ctx.tick.value % 50 === 0 ? '#9CA3AF' : '#E5E7EB'),
                              lineWidth: (ctx) => (ctx.tick.value % 50 === 0 ? 1.5 : 0.5)
                          }
                      },
                      x: {
                          ticks: {
                              maxRotation: 45, 
                              minRotation: 45,
                              callback: function(value, index) {
                                  const fullLabel = this.getLabelForValue(value);
                                  return (index % 6 === 0) ? fullLabel : fullLabel.split(' ')[1];
                              }
                          }
                      }
                  }
              }
          });
          debugLog('åœ–è¡¨ç¹ªè£½æˆåŠŸï¼', 'success');
      } catch (e) {
          debugLog(`åœ–è¡¨ç¹ªè£½å¤±æ•—: ${e.message}`, 'error');
      }
  };
  </script>
</body>
</html>
