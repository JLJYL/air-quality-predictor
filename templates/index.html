<script>
        // --- 1. 數據變數安全傳輸 ---
        // 確保數據是有效的 JSON 字符串，並安全解析
        const aqi_predictions_json = '{{ aqi_predictions | tojson | safe }}';
        const pollutant_predictions_json = '{{ pollutant_predictions | tojson | safe }}';

        let predictions = [];
        let pollutant_predictions = {};

        try {
            predictions = JSON.parse(aqi_predictions_json);
        } catch (e) {
            console.error("無法解析 AQI 預測數據:", e, aqi_predictions_json);
            // 如果解析失敗，則保留空陣列
        }

        try {
            pollutant_predictions = JSON.parse(pollutant_predictions_json);
        } catch (e) {
            console.error("無法解析污染物預測數據:", e, pollutant_predictions_json);
            // 如果解析失敗，則保留空物件
        }
        // ---------------------------

        function getAqiColorClass(aqi) {
            if (aqi === "N/A" || isNaN(aqi) || aqi === null) return 'aqi-default'; 
            if (aqi <= 50) return 'aqi-50';
            if (aqi <= 100) return 'aqi-100';
            if (aqi <= 150) return 'aqi-150';
            if (aqi <= 200) return 'aqi-200';
            return 'aqi-300';
        }

        function getAqiColor(aqi) {
            if (aqi === "N/A" || isNaN(aqi) || aqi === null) return '#9CA3AF';
            if (aqi <= 50) return '#10B981';
            if (aqi <= 100) return '#EAB308';
            if (aqi <= 150) return '#F97316';
            if (aqi <= 200) return '#DC2626';
            return '#7C3AED';
        }

        function updateAqiColors() {
            const maxAqiValue = document.getElementById('maxAqiValue').innerText.trim();
            const aqiStatusElement = document.getElementById('aqiStatus');
            
            const parsedAqi = parseInt(maxAqiValue);

            // 移除所有顏色類別以避免衝突
            ['aqi-50', 'aqi-100', 'aqi-150', 'aqi-200', 'aqi-300', 'aqi-default'].forEach(c => {
                aqiStatusElement.classList.remove(c);
            });

            if (maxAqiValue !== "N/A" && !isNaN(parsedAqi)) {
                aqiStatusElement.classList.add(getAqiColorClass(parsedAqi)); 
                aqiStatusElement.classList.add('text-white');
            } else {
                aqiStatusElement.classList.add('aqi-default');
                aqiStatusElement.classList.add('text-white');
            }
        }

        // --- 繪製多條線的污染物趨勢圖 ---
        function createMultiPollutantChart(elementId, pollutantKeys, chartTitle) {
            const ctx = document.getElementById(elementId);
            if (!ctx) return;
            const context = ctx.getContext('2d');
            
            // 確保數據存在且有標籤
            if (Object.keys(pollutant_predictions).length === 0 || !pollutant_predictions[pollutantKeys[0]]) {
                return;
            }

            // 使用第一個污染物數據來產生時間標籤
            const labels = pollutant_predictions[pollutantKeys[0]].map(p => {
                const parts = p.time.split(' '); 
                const time = parts[1]; 
                return time; 
            });

            const datasets = [];

            // 定義污染物顏色、單位和 Y 軸 ID
            const pollutant_configs = {
                'PM25': { label: 'PM2.5 (μg/m³)', color: 'rgb(245, 158, 11)', unit: 'μg/m³', yAxisID: 'y1' },
                'PM10': { label: 'PM10 (μg/m³)', color: 'rgb(59, 130, 246)', unit: 'μg/m³', yAxisID: 'y1' },
                'O3': { label: 'O3 (ppm)', color: 'rgb(16, 185, 129)', unit: 'ppm', yAxisID: 'y2' },
                'NO2': { label: 'NO2 (ppm)', color: 'rgb(239, 68, 68)', unit: 'ppm', yAxisID: 'y2' },
                'SO2': { label: 'SO2 (ppm)', color: 'rgb(139, 92, 246)', unit: 'ppm', yAxisID: 'y2' },
                'CO': { label: 'CO (ppm)', color: 'rgb(75, 85, 99)', unit: 'ppm', yAxisID: 'y2' },
            };

            pollutantKeys.forEach(key => {
                const config = pollutant_configs[key];
                if (pollutant_predictions[key]) {
                    const data = pollutant_predictions[key].map(p => parseFloat(p.value));
                    datasets.push({
                        label: config.label,
                        data: data,
                        borderColor: config.color,
                        backgroundColor: config.color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                        yAxisID: config.yAxisID,
                        tension: 0.2, borderWidth: 2, pointRadius: 1,
                    });
                }
            });

            // 確定要顯示哪個 Y 軸
            const isParticulateChart = pollutantKeys.includes('PM25') || pollutantKeys.includes('PM10');

            new Chart(context, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { boxWidth: 10, font: { size: 12 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const unit = context.dataset.label.includes('(μg/m³)') ? 'μg/m³' : 'ppm';
                                    const value = context.parsed.y;
                                    const label = context.dataset.label.split(' ')[0];
                                    return `${label}: ${value.toFixed(3)} ${unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } }
                        },
                        // PM2.5/PM10 軸 (左側)
                        y1: { 
                            type: 'linear', position: 'left', 
                            display: isParticulateChart, // 僅在粒子物圖表上顯示
                            title: { display: isParticulateChart, text: '濃度 (μg/m³)', font: { size: 11 } },
                            min: 0,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        // 氣體污染物軸 (左側)
                        y2: { 
                            type: 'linear', position: 'left', 
                            display: !isParticulateChart, // 僅在氣體圖表上顯示
                            title: { display: !isParticulateChart, text: '濃度 (ppm)', font: { size: 11 } },
                            min: 0,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                }
            });
        }
        // --- 結束: 繪製多條線的污染物趨勢圖 ---


        function createAqiChart() {
            
            if (!predictions || predictions.length === 0) {
                return;
            }

            // AQI Chart 建立邏輯 
            const labels = predictions.map(p => {
                const parts = p.time.split(' '); 
                const date = parts[0].substring(5); 
                const time = parts[1]; 
                return `${date} ${time}`; 
            });

            const data = predictions.map(p => {
                const aqi = p.aqi;
                return (aqi === "N/A" || isNaN(aqi) || aqi === null) ? null : parseInt(aqi);
            });

            const borderColors = data.map(aqi => getAqiColor(aqi));

            const ctx = document.getElementById('aqiChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'AQI 數值',
                        data: data,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: borderColors,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7,
                        segment: {
                            borderColor: ctx => {
                                const index = ctx.p0DataIndex;
                                return borderColors[index] || '#3B82F6';
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    const aqi = context.parsed.y;
                                    let status = '';
                                    if (aqi <= 50) status = '良好';
                                    else if (aqi <= 100) status = '普通';
                                    else if (aqi <= 150) status = '對敏感族群不健康';
                                    else if (aqi <= 200) status = '不健康';
                                    else status = '非常不健康';
                                    return `AQI: ${aqi} (${status})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 500,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: { font: { size: 12 } },
                            title: {
                                display: true,
                                text: 'AQI 數值',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 45,
                                callback: function(value, index, values) {
                                    const fullLabel = this.getLabelForValue(value);
                                    const parts = fullLabel.split(' '); 
                                    
                                    if (index % 6 === 0) { 
                                        return fullLabel;
                                    }
                                    return parts[1]; 
                                }
                            },
                            title: {
                                display: true,
                                text: '日期與時間',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                }
            });
            
            // 繪製污染物圖表
            if (Object.keys(pollutant_predictions).length > 0) {
                // 將污染物分成三組，每組繪製在一張圖上
                createMultiPollutantChart('chartParticulates', ['PM25', 'PM10'], 'PM2.5 / PM10 趨勢');
                createMultiPollutantChart('chartO3NO2', ['O3', 'NO2'], 'O3 / NO2 趨勢');
                createMultiPollutantChart('chartSO2CO', ['SO2', 'CO'], 'SO2 / CO 趨勢');
            }
        }

        window.onload = function() {
            updateAqiColors();
            createAqiChart();
        };
    </script>
