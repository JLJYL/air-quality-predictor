<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ city_name }} - AQI 24 小時預測</title>
    <!-- 導入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 導入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* 確保字體和背景 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        /* 定義 AQI 顏色類別 */
        .aqi-good { background-color: #00e400; color: white; } /* 0-50 綠色 */
        .aqi-moderate { background-color: #ff9900; color: white; } /* 51-100 黃色/橘色 */
        .aqi-unhealthy-sensitive { background-color: #ff0000; color: white; } /* 101-150 紅色 */
        .aqi-unhealthy { background-color: #8f3f97; color: white; } /* 151-200 紫色 */
        .aqi-very-unhealthy { background-color: #7e0023; color: white; } /* > 200 栗色 */
        .aqi-na { background-color: #a0a0a0; color: white; } /* N/A 灰色 */
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 tracking-tight">
                {{ city_name }} 空氣品質預測
            </h1>
            <p class="text-lg text-gray-500 mt-1">未來 24 小時 AQI 趨勢分析</p>
        </header>

        <!-- Current Status & Max AQI Card -->
        <div class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Max AQI Card -->
            <div class="p-6 rounded-lg shadow-xl" id="max-aqi-card">
                <p class="text-sm font-semibold text-gray-700 uppercase">預測期間 (24H) 最高 AQI</p>
                <div class="flex items-center justify-between mt-2">
                    <span id="max-aqi-display" class="text-6xl font-extrabold">{{ max_aqi }}</span>
                    <span id="aqi-status" class="text-xl font-bold rounded-full px-4 py-2 shadow-md"></span>
                </div>
                <p class="text-sm text-gray-500 mt-3">
                    {% if is_fallback %}
                    <span class="font-bold text-red-500">⚠️ 僅顯示最新觀測值。</span> 預測模型無法啟動。
                    {% else %}
                    預測期間 (24H) 的最高指數。
                    {% endif %}
                </p>
            </div>

            <!-- Current Observation Time -->
            <div class="p-6 bg-blue-50 rounded-lg shadow-inner flex flex-col justify-center">
                <p class="text-sm font-semibold text-blue-700 uppercase">最新觀測時間 (本地時區)</p>
                <p class="text-2xl font-bold text-gray-800 mt-1">{{ current_obs_time }}</p>
                <p class="text-sm text-gray-500 mt-3">
                    數據來自 OpenAQ 平台，用於模型預測起點。
                </p>
            </div>
        </div>
        
        <!-- Prediction Chart Section -->
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">AQI 24 小時預測趨勢</h2>
            <div class="h-80 w-full">
                <canvas id="aqiChart"></canvas>
            </div>
            <p class="text-xs text-gray-400 mt-4 text-center">
                曲線圖顯示未來 24 個小時的空氣品質指數 (AQI) 預測值。
            </p>
        </div>

    </div>

    <!-- JavaScript for Chart Drawing and UI Updates -->
    <script>
        const aqiPredictions = {{ aqi_predictions | tojson }};
        // 修正: 使用 | tojson 確保 max_aqi 以正確的 JavaScript 字面量形式 (數字或引號字串) 插入
        const maxAqiValue = {{ max_aqi | tojson }}; 
        const isFallback = {{ is_fallback | tojson }};

        /**
         * 根據 AQI 值獲取對應的顏色和描述
         * @param {number} aqi 
         * @returns {{color: string, status: string, tailwindClass: string}}
         */
        function getAqiInfo(aqi) {
            if (aqi === 'N/A' || isNaN(aqi) || aqi === null) {
                return { color: '#a0a0a0', status: '無數據', tailwindClass: 'aqi-na' };
            }
            if (aqi <= 50) return { color: '#00e400', status: '良好', tailwindClass: 'aqi-good' };
            if (aqi <= 100) return { color: '#ff9900', status: '普通', tailwindClass: 'aqi-moderate' };
            if (aqi <= 150) return { color: '#ff0000', status: '對敏感族群不健康', tailwindClass: 'aqi-unhealthy-sensitive' };
            if (aqi <= 200) return { color: '#8f3f97', status: '不健康', tailwindClass: 'aqi-unhealthy' };
            return { color: '#7e0023', status: '非常不健康', tailwindClass: 'aqi-very-unhealthy' };
        }

        /**
         * 更新頁面上的最高 AQI 狀態卡片
         */
        function updateAqiStatusCard() {
            const aqi = parseInt(maxAqiValue);
            const info = getAqiInfo(aqi);
            const card = document.getElementById('max-aqi-card');
            const statusSpan = document.getElementById('aqi-status');
            
            // 移除舊的背景色並添加新的背景色
            const classesToRemove = ['aqi-good', 'aqi-moderate', 'aqi-unhealthy-sensitive', 'aqi-unhealthy', 'aqi-very-unhealthy', 'aqi-na'];
            statusSpan.classList.remove(...classesToRemove);
            statusSpan.classList.add(info.tailwindClass);

            statusSpan.textContent = info.status;
            
            // 根據狀態顏色更新卡片邊框/陰影顏色
            card.style.borderColor = info.color;
            card.style.borderWidth = '4px';
            card.style.boxShadow = `0 10px 15px -3px ${info.color}66, 0 4px 6px -4px ${info.color}44`;
        }

        /**
         * 繪製 Chart.js 折線圖
         */
        function drawChart() {
            const ctx = document.getElementById('aqiChart').getContext('2d');
            
            // 處理數據，過濾掉 'N/A'
            const validPredictions = aqiPredictions.filter(p => p.aqi !== 'N/A' && p.aqi !== null && !isNaN(p.aqi));
            
            let labels = validPredictions.map(p => {
                // 轉換時間格式為 HH:MM
                const parts = p.time.split(' ');
                return parts.length > 1 ? parts[1].substring(0, 5) : p.time;
            });
            let data = validPredictions.map(p => p.aqi);
            let colors = validPredictions.map(p => getAqiInfo(p.aqi).color);
            
            // 如果只有一個點 (回退模式)，則複製該點以繪製單點圖
            if (isFallback && data.length === 1) {
                const obsTime = validPredictions[0].time.split(' ')[1].substring(0, 5);
                // 模擬未來兩小時的預測 (實際應用中不應如此，但為了顯示圖表不為空)
                labels = [obsTime];
                data = [data[0]];
                colors = [colors[0]];
                
                // 為了讓 Chart.js 顯示一個點，我們需要至少 2 個數據點
                if (labels.length === 1) {
                    labels.push(''); // 添加一個空標籤
                    data.push(data[0]); // 重複數據點
                    colors.push(colors[0]);
                }
            } else if (isFallback && data.length === 0) {
                 // 在無數據時顯示警告
                ctx.font = '16px Inter';
                ctx.fillStyle = '#ef4444';
                ctx.textAlign = 'center';
                ctx.fillText('無法取得有效預測數據。', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }


            // 繪製線圖
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'AQI 預測值',
                        data: data,
                        backgroundColor: (context) => {
                            const aqi = context.dataset.data[context.dataIndex];
                            return getAqiInfo(aqi).color;
                        },
                        borderColor: '#2563eb', // 線條顏色
                        borderWidth: 3,
                        pointRadius: 6,
                        pointBackgroundColor: colors,
                        pointHoverRadius: 8,
                        tension: 0.3, // 使線條更平滑
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: isFallback ? '🚨 僅顯示單一觀測數據' : '未來 24 小時 AQI 預測',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '時間 (本地時區)'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                // 只顯示每 3 個標籤，避免過度擁擠
                                callback: function(value, index, values) {
                                    return index % 3 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'AQI 指數'
                            },
                            min: 0,
                            max: 200, // 固定 Y 軸範圍以保持一致性
                            grid: {
                                borderColor: '#ddd',
                                borderWidth: 1,
                                color: (context) => {
                                    // 添加重要的 AQI 閾值線
                                    if (context.tick.value === 50) return '#00e400';
                                    if (context.tick.value === 100) return '#ff9900';
                                    if (context.tick.value === 150) return '#ff0000';
                                    return 'rgba(0, 0, 0, 0.1)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 頁面載入後執行
        window.onload = function() {
            updateAqiStatusCard();
            drawChart();
        };

    </script>
</body>
</html>
