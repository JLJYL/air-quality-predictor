<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ city_name }} 空氣品質預測</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7ff;
        }
        .aqi-50 { @apply bg-green-500; }
        .aqi-100 { @apply bg-yellow-500; }
        .aqi-150 { @apply bg-orange-500; }
        .aqi-200 { @apply bg-red-600; }
        .aqi-300 { @apply bg-purple-700; }
        .aqi-default { @apply bg-gray-400; }

        /* 使用 Tailwind Grid 來佈局污染物圖表，使其在寬螢幕上兩兩一組，類似你的圖片風格 */
        .pollutant-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 預設兩欄 */
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .pollutant-grid {
                grid-template-columns: 1fr; /* 小螢幕變為單欄 */
            }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">
                {{ city_name }} 空氣品質{% if not is_fallback %}預測{% else %}觀測{% endif %}
            </h1>
            
            {% if not is_fallback %}
            <p class="text-lg text-gray-600">未來 {{ aqi_predictions | length if aqi_predictions else 24 }} 小時 AQI/污染物趨勢</p>
            <p class="text-sm text-gray-400 mt-1">（數據初始化於應用程式啟動時完成）</p>
            {% else %}
            <p class="text-lg text-red-500 font-bold">⚠️ 無法載入模型或進行預測，目前顯示最新觀測數據。</p>
            <p class="text-sm text-gray-600 mt-1">最新觀測時間：{{ current_obs_time }}</p>
            {% endif %}
        </header>

        <div id="maxAqiCard" class="shadow-2xl rounded-xl p-6 md:p-8 mb-10 text-white transition duration-500 transform hover:scale-[1.01] flex flex-col md:flex-row justify-between items-center" 
             style="background-color: #2c3e50;">
            
            <div class="mb-4 md:mb-0">
                <p class="text-lg font-medium opacity-80">
                    {% if not is_fallback %}
                        未來 24 小時內最大預測 AQI
                    {% else %}
                        最新觀測 AQI
                    {% endif %}
                </p>
                <h2 id="maxAqiValue" class="text-6xl md:text-7xl font-black mt-1">
                    {{ max_aqi }}
                </h2>
            </div>
            
            <div id="aqiStatus" class="rounded-full px-6 py-2 text-xl font-bold shadow-md">
                {% if max_aqi == "N/A" %}
                    N/A
                {% elif max_aqi | int <= 50 %}
                    良好
                {% elif max_aqi | int <= 100 %}
                    普通
                {% elif max_aqi | int <= 150 %}
                    對敏感族群不健康
                {% elif max_aqi | int <= 200 %}
                    不健康
                {% else %}
                    非常不健康
                {% endif %}
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-xl p-6 mb-10">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">
                AQI 總體趨勢圖
            </h3>
            <div class="relative" style="height: 400px;">
                <canvas id="aqiChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-xl p-6 mb-10">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">
                主要污染物濃度趨勢 (未來 24 小時)
            </h3>
            <div class="pollutant-grid">
                <div class="relative bg-gray-50 p-4 rounded-lg shadow-inner">
                    <h4 class="text-center font-bold text-lg text-gray-800 mb-2">PM2.5 / PM10</h4>
                    <div style="height: 250px;"><canvas id="chartParticulates"></canvas></div>
                </div>
                
                <div class="relative bg-gray-50 p-4 rounded-lg shadow-inner">
                    <h4 class="text-center font-bold text-lg text-gray-800 mb-2">O3 (臭氧) / NO2 (二氧化氮)</h4>
                    <div style="height: 250px;"><canvas id="chartO3NO2"></canvas></div>
                </div>

                <div class="relative bg-gray-50 p-4 rounded-lg shadow-inner">
                    <h4 class="text-center font-bold text-lg text-gray-800 mb-2">SO2 (二氧化硫) / CO (一氧化碳)</h4>
                    <div style="height: 250px;"><canvas id="chartSO2CO"></canvas></div>
                </div>
            </div>
        </div>

    </div> 
    <script>
        function getAqiColorClass(aqi) {
            if (aqi === "N/A" || isNaN(aqi) || aqi === null) return 'aqi-default'; 
            if (aqi <= 50) return 'aqi-50';
            if (aqi <= 100) return 'aqi-100';
            if (aqi <= 150) return 'aqi-150';
            if (aqi <= 200) return 'aqi-200';
            return 'aqi-300';
        }

        function getAqiColor(aqi) {
            if (aqi === "N/A" || isNaN(aqi) || aqi === null) return '#9CA3AF';
            if (aqi <= 50) return '#10B981';
            if (aqi <= 100) return '#EAB308';
            if (aqi <= 150) return '#F97316';
            if (aqi <= 200) return '#DC2626';
            return '#7C3AED';
        }

        function updateAqiColors() {
            const maxAqiValue = document.getElementById('maxAqiValue').innerText.trim();
            const aqiStatusElement = document.getElementById('aqiStatus');
            
            const parsedAqi = parseInt(maxAqiValue);

            // 移除所有顏色類別以避免衝突
            ['aqi-50', 'aqi-100', 'aqi-150', 'aqi-200', 'aqi-300', 'aqi-default'].forEach(c => {
                aqiStatusElement.classList.remove(c);
            });

            if (maxAqiValue !== "N/A" && !isNaN(parsedAqi)) {
                aqiStatusElement.classList.add(getAqiColorClass(parsedAqi)); 
                aqiStatusElement.classList.add('text-white');
            } else {
                aqiStatusElement.classList.add('aqi-default');
                aqiStatusElement.classList.add('text-white');
            }
        }

        // --- 新增: 繪製多條線的污染物趨勢圖 ---
        function createMultiPollutantChart(elementId, pollutantData, chartTitle) {
            const ctx = document.getElementById(elementId).getContext('2d');
            
            // 由於我們不知道您的後端資料格式，這裡使用一個模擬數據，以便圖表能正常顯示。
            // 請確保您的後端 { pollutant_predictions } 包含 PM25, PM10, O3, NO2, SO2, CO 的預測資料。
            const pollutant_predictions = {{ pollutant_predictions | tojson | safe }};

            // 確保資料存在
            if (!pollutantData || pollutantData.length === 0 || !pollutant_predictions) {
                return;
            }

            const labels = pollutant_predictions.PM25 ? pollutant_predictions.PM25.map(p => {
                const parts = p.time.split(' '); 
                const time = parts[1]; 
                return time; 
            }) : [];

            const datasets = [];

            // 粒子物圖表
            if (elementId === 'chartParticulates') {
                const pm25Data = pollutant_predictions.PM25 ? pollutant_predictions.PM25.map(p => parseFloat(p.value)) : [];
                const pm10Data = pollutant_predictions.PM10 ? pollutant_predictions.PM10.map(p => parseFloat(p.value)) : [];

                datasets.push({
                    label: 'PM2.5 (μg/m³)',
                    data: pm25Data,
                    borderColor: 'rgb(245, 158, 11)', // 橙色
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    yAxisID: 'y1', // 使用 y1 軸
                    tension: 0.2, borderWidth: 2, pointRadius: 1,
                });
                datasets.push({
                    label: 'PM10 (μg/m³)',
                    data: pm10Data,
                    borderColor: 'rgb(59, 130, 246)', // 藍色
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    yAxisID: 'y1', // 使用 y1 軸
                    tension: 0.2, borderWidth: 2, pointRadius: 1,
                });
            } 
            // 氣體圖表 1 (O3, NO2)
            else if (elementId === 'chartO3NO2') {
                const o3Data = pollutant_predictions.O3 ? pollutant_predictions.O3.map(p => parseFloat(p.value)) : [];
                const no2Data = pollutant_predictions.NO2 ? pollutant_predictions.NO2.map(p => parseFloat(p.value)) : [];

                datasets.push({
                    label: 'O3 (ppm)',
                    data: o3Data,
                    borderColor: 'rgb(16, 185, 129)', // 綠色
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    yAxisID: 'y2', // 使用 y2 軸
                    tension: 0.2, borderWidth: 2, pointRadius: 1,
                });
                datasets.push({
                    label: 'NO2 (ppm)',
                    data: no2Data,
                    borderColor: 'rgb(239, 68, 68)', // 紅色
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    yAxisID: 'y2', // 使用 y2 軸
                    tension: 0.2, borderWidth: 2, pointRadius: 1,
                });
            }
            // 氣體圖表 2 (SO2, CO)
            else if (elementId === 'chartSO2CO') {
                const so2Data = pollutant_predictions.SO2 ? pollutant_predictions.SO2.map(p => parseFloat(p.value)) : [];
                const coData = pollutant_predictions.CO ? pollutant_predictions.CO.map(p => parseFloat(p.value)) : [];

                datasets.push({
                    label: 'SO2 (ppm)',
                    data: so2Data,
                    borderColor: 'rgb(139, 92, 246)', // 紫色
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    yAxisID: 'y2', // 使用 y2 軸
                    tension: 0.2, borderWidth: 2, pointRadius: 1,
                });
                datasets.push({
                    label: 'CO (ppm)',
                    data: coData,
                    borderColor: 'rgb(75, 85, 99)', // 灰色
                    backgroundColor: 'rgba(75, 85, 99, 0.1)',
                    yAxisID: 'y2', // 使用 y2 軸
                    tension: 0.2, borderWidth: 2, pointRadius: 1,
                });
            }


            new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { boxWidth: 10, font: { size: 12 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const unit = context.dataset.label.includes('(μg/m³)') ? 'μg/m³' : 'ppm';
                                    const value = context.parsed.y;
                                    const label = context.dataset.label.split(' ')[0];
                                    return `${label}: ${value.toFixed(3)} ${unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } }
                        },
                        // PM2.5/PM10 軸
                        y1: { 
                            type: 'linear', position: 'left', display: elementId === 'chartParticulates',
                            title: { display: true, text: '濃度 (μg/m³)', font: { size: 11 } },
                            min: 0,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        // 氣體污染物軸
                        y2: { 
                            type: 'linear', position: 'left', display: elementId !== 'chartParticulates',
                            title: { display: true, text: '濃度 (ppm)', font: { size: 11 } },
                            min: 0,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                }
            });
        }
        // --- 結束: 繪製多條線的污染物趨勢圖 ---


        function createAqiChart() {
            // 假設後端提供 AQI 和污染物預測數據
            const predictions = {{ aqi_predictions | tojson | safe }};
            const pollutant_predictions = {{ pollutant_predictions | tojson | safe }};
            
            if (!predictions || predictions.length === 0) {
                return;
            }

            // AQI Chart 建立邏輯 (與上次相同)
            const labels = predictions.map(p => {
                const parts = p.time.split(' '); 
                const date = parts[0].substring(5); 
                const time = parts[1]; 
                return `${date} ${time}`; 
            });

            const data = predictions.map(p => {
                const aqi = p.aqi;
                return (aqi === "N/A" || isNaN(aqi)) ? null : parseInt(aqi);
            });

            const borderColors = data.map(aqi => getAqiColor(aqi));

            const ctx = document.getElementById('aqiChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'AQI 數值',
                        data: data,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: borderColors,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7,
                        segment: {
                            borderColor: ctx => {
                                const index = ctx.p0DataIndex;
                                return borderColors[index] || '#3B82F6';
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    const aqi = context.parsed.y;
                                    let status = '';
                                    if (aqi <= 50) status = '良好';
                                    else if (aqi <= 100) status = '普通';
                                    else if (aqi <= 150) status = '對敏感族群不健康';
                                    else if (aqi <= 200) status = '不健康';
                                    else status = '非常不健康';
                                    return `AQI: ${aqi} (${status})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 500,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: { font: { size: 12 } },
                            title: {
                                display: true,
                                text: 'AQI 數值',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 45,
                                callback: function(value, index, values) {
                                    const fullLabel = this.getLabelForValue(value);
                                    const parts = fullLabel.split(' '); 
                                    
                                    if (index % 6 === 0) { 
                                        return fullLabel;
                                    }
                                    return parts[1]; 
                                }
                            },
                            title: {
                                display: true,
                                text: '日期與時間',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                }
            });
            
            // 繪製污染物圖表
            if (pollutant_predictions && pollutant_predictions.PM25) {
                // 將污染物分成三組，每組繪製在一張圖上
                createMultiPollutantChart('chartParticulates', [pollutant_predictions.PM25, pollutant_predictions.PM10], 'PM2.5 / PM10 趨勢');
                createMultiPollutantChart('chartO3NO2', [pollutant_predictions.O3, pollutant_predictions.NO2], 'O3 / NO2 趨勢');
                createMultiPollutantChart('chartSO2CO', [pollutant_predictions.SO2, pollutant_predictions.CO], 'SO2 / CO 趨勢');
            }
        }

        window.onload = function() {
            updateAqiColors();
            createAqiChart();
        };
    </script>
</body>
</html>
